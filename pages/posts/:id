<!-- begin #page - the container for everything but header -->
<div id="page">
    <div class="container clearfix" id="main-content"> 
        <!--begin main content-->
    </div>

    <!--<div class="row-fluid" id="blog_detail_container_4">-->
    <!--    <script id="blog_detail_template_4" type="x-tmpl-mustache">-->
    <!--        <div class="span10 offset1 entry-related">-->
    <!--            <h4 class="short_headline"><span><b>Related</b>Stories</span></h4>-->
    <!--            <div class="row-fluid equalHero equalHeights">-->
    <!--                {{#.}}-->
    <!--                <div class="span4 sparkNowTile">-->
    <!--                    <div class="sparkNowTileTop">-->
    <!--                        {{#tag_first}}-->
    <!--                            <a href="/posts/{{slug}}" class="sparkNowTileTag">{{.}}</a>-->
    <!--                        {{/tag_first}}-->
    <!--                        <a href="/posts/{{slug}}" class="sparkNowTileImg">-->
    <!--                            <img src="{{image_url}}" class="aligncenter" alt="" />-->
    <!--                        </a>-->
    <!--                    </div>-->
    <!--                    <div class="sparkNowTileTitle"><a href="/posts/{{slug}}"><h3>{{ title }}</h3></a></div>-->
    <!--                </div>-->
    <!--                {{/.}}-->
    <!--            </div>-->
    <!--        </div>-->
    <!--    </script>-->
    <!--</div>-->
</div>
<style>
    #blog_detail_container_1{
        margin-top:50px;
    }
    @media only screen and (max-width: 767px) {
        #blog_detail_container_1{
            display:none;
            
        }
        .blog-detail{
            border-right:none;
        }
    }
</style>

<!-- Go to www.addthis.com/dashboard to customize your tools -->
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-552bf365691d2c2d" async="async"></script>
<script>
    $(document).ready(function() {
        function renderPageData(){
            var pathArray = window.location.pathname.split( '/' );
            var slug = pathArray[pathArray.length-1];
            var blog_detail = getPostDetailsBySlug(slug);
            // checkErrorPage(blog_detail);
           
            var publish_date = new Date(blog_detail.publish_date);
            
            var month_names_short = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec']
            blog_detail.publish_date_month = month_names_short[publish_date.getMonth()]
            blog_detail.publish_date_day = publish_date.getDate()

            renderPostDetailTemplate('#blog_detail_template_1', '#blog_detail_container_1',blog_detail);
            renderPostDetailTemplate('#blog_detail_template_2', '#blog_detail_container_2',blog_detail);
            renderPostListTemplate('#blog_detail_template_3', '#blog_detail_container_3',getPostList());

            //change img url
            $('.blog_detail_description img').attr('src',function(i,e){
                return e.replace("/system","http://cdn.mallmaverick.com/system");
            });
        }
        
        loadMallData(renderPageData);
    });
    
    function renderPostDetailTemplate(blog_detail_template, blog_block, post){
    
        var item_list = [];
        var blog_template_html = $(blog_detail_template).html();
        Mustache.parse(blog_template_html);   // optional, speeds up future uses
        post.prev_post = getPrevPostBySlug(post.slug);
        post.next_post = getNextPostBySlug(post.slug);
        
        var blog_rendered = Mustache.render(blog_template_html,post);
        item_list.push(blog_rendered);
        $(blog_block).html(item_list.join(''));
    }
    
    function renderPostListTemplate(blog_template, blog_block, post){
        var item_list = [];
        var item_rendered = [];
        var blog_template_html = $(blog_template).html();
        Mustache.parse(blog_template_html);   // optional, speeds up future uses

        $.each( post, function( index, value ) {
            // MAX # IS 10
            if (index >= 10) {return false;};

            var publish_date = new Date(value.publish_date);
            
            var month_names_short = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec']
            value.publish_date_month = month_names_short[publish_date.getMonth()]
            value.publish_date_day = publish_date.getDate()

            item_list.push(value);
        });

        item_list.sort(function(a, b){
            if(a.publish_date > b.publish_date) return -1;
            if(a.publish_date < b.publish_date) return 1;
            return 0;
        });

        var blog_rendered = Mustache.render(blog_template_html,item_list);
        $(blog_block).html(blog_rendered);
    }

    function renderPostRelatedTemplate(blog_template, blog_block, posts, current_post){
        var item_list = [];
        var item_rendered = [];
        var blog_template_html = $(blog_template).html();
        Mustache.parse(blog_template_html);   // optional, speeds up future uses

        $.each( posts, function( index, value ) {
            // MAX # IS 3
            if (item_list.length >= 3) {return false;};

            console.log($(value.tag).filter(current_post.tag).length);
            if ($(value.tag).filter(current_post.tag).length > 0 && 
                value.id != current_post.id) {
                console.log(value);
                value.tag_first = value.tag[0];
                item_list.push(value);
            };
        });

        item_list.sort(function(a, b){
            if(a.publish_date > b.publish_date) return -1;
            if(a.publish_date < b.publish_date) return 1;
            return 0;
        });
        var blog_rendered = Mustache.render(blog_template_html,item_list);
        $(blog_block).html(blog_rendered);
    }
</script>    