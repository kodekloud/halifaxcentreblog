<!-- begin #page - the container for everything but header -->
<div id="page">
    <div class="container visible-phone">
        <p class="right"><a class="btn btn-primary scrollto" href="#secondary-nav">Blog Menu &nbsp;<i class="icon-align-justify"></i></a></p>
    </div>
    <div class="container clearfix" id="main-content"> 
        <!--begin main content-->
        <div class="row-fluid sidebar-right" id="blog_detail_container"> 
            <script id="blog_detail_template" type="x-tmpl-mustache">
                <!--begin row-fluid-->
                <div class="span2">
                    <div id="postSocial">
                        <ul class="blogposts">
                            <li>
                                <span class="date"> 
                                    <span class="month">{{publish_date_month}}</span>
                                    <span class="day"><b>{{publish_date_day}}</b></span>
                                </span>
                            </li>
                            <li><a href="https://www.facebook.com/StVitalCentre" target="_blank"><img src="http://kodekloud.s3.amazonaws.com/sites/5512e0606e6f64112d000000/a4f210f3e9502396b14baeff5101625d/facebook.png"></a></li>
                            <li><a href="http://www.pinterest.com/stvitalcentre" target="_blank"><img src="http://kodekloud.s3.amazonaws.com/sites/5512e0606e6f64112d000000/a4f210f3e9502396b14baeff5101625d/pinter.png"></a></li>
                            <li><a href="https://twitter.com/StVitalCentre" target="_blank"><img src="http://kodekloud.s3.amazonaws.com/sites/5512e0606e6f64112d000000/a4f210f3e9502396b14baeff5101625d/twitter.png"></a></li>
                        </ul>
                    </div>
                </div>
                <div class="span7 blog-detail primary-column"> 
                    <!--begin primary-column-->
                    <div class="blog-detail-nav">
                        <a href="{{ prev_post.slug }}">PREVIOUS STORY</a>
                        <a href="{{ next_post.slug }}">NEXT STORY</a>
                    </div>
                    <article class="entry-post">
                        <header class="entry-header">
                            {{#video_link}}
                                <div class="video-container" id="post_video">
                                    <iframe width="560" height="315" src="//www.youtube.com/embed/{{.}}" frameborder="0" allowfullscreen></iframe>
                                </div>
                            {{/video_link}}
                            {{#image_url}}
                                <img id="post_image" src="{{.}}" />
                            {{/image_url}}
                            <h1>{{ title }}</h1>
                            <!-- AddThis Button BEGIN -->
                            <div class="addthis_toolbox addthis_default_style ">
                            <a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
                            <a class="addthis_button_facebook_share" fb:share:layout="button_count"></a>
                            <a class="addthis_button_pinterest_pinit" pi:pinit:layout="horizontal"></a>
                            <a class="addthis_button_tweet"></a>
                            <a class="addthis_counter addthis_pill_style"></a>
                            </div>
                            <!--<script type="text/javascript">var addthis_config = {"data_track_addressbar":true};</script>-->
                            <!--<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5150b79556552030"></script>-->
                            <!-- AddThis Button END -->
                            {{ body }}
                        </header>
                        <!--end entry-header-->
                        <div class="entry-tags">
                            <p>TAGS</p>
                            {{#tag}}
                                <a href="/posts?tag={{tag}}" rel="tag">{{.}}</a><span> /</span>
                            {{/tag}}
                        </div>                  
                    </article>
                    <!--end entry-post -->
                    
                    <!--begin comments section-->
                    <section id="view-comments" class="entry-comments clearfix">
                        <!-- DISQUS start -->
                        <div id="disqus_thread"></div>
                        <script type="text/javascript">
                            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
                            var disqus_shortname = 'stvitalcentre'; // required: replace example with your forum shortname
                    
                            /* * * DON'T EDIT BELOW THIS LINE * * */
                            (function() {
                                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                            })();
                        </script>
                        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
                        <!-- DISQUS end -->
                    </section>
                    <!--close comment section-->  
            </script>
        </div>
        <!-- close span9 blog-detail primary-column-->
        <section class="span3 sidebar secondary-column" id="secondary-nav">
            <aside class="widget">
                <h5 class="short_headline"><span><b>LATEST</b>POSTS</span></h5>
                <div class="sidebar-tabs" id="blog_list_container">
                    <script id="blog_list_template" type="x-tmpl-mustache">
                    <div class="panels">
                        <div id="tab-latest">
                            <ul class="blogposts clearfix">
                                {{#}}
                                    <li> 
                                        <span class="date"> 
                                            // <span class="month">{{ post.publish_date | date: "%b"}}</span> 
                                            // <span class="day" style="font-size:11.43px;"><b>{{ post.publish_date | date: "%-d"}}</b></span> 
                                            // <span class="year">{{ post.publish_date | date: "%Y"}}</span> 
                                        </span>
                                        <h3><a href="/posts/{{slug}}" title="{{ title }}">{{ title }}</a></h3>
                                        <p></p>
                                    </li>
                                {{/}}
                            </ul>
                        </div>
                    </div>
                    <!--close .panels (all of them)--> 
                    </script>
                </div>
                <!--close .sidebar-tabs--> 
            </aside>
            <!-- close .widget containing blog tabs-->
        </section>
        <!--close section sidebar span3--> 
    </div>
    <!--close row-fluid--> 
        {% if related_posts != nil and related_posts != empty %}
        <div class="row-fluid">
            <div class="span10 offset1 entry-related">
                <h4 class="short_headline"><span><b>Related</b>Stories</span></h4>
                {% for post in related_posts limit:3 %}
                    {% capture thecycle %}{% cycle 'one', 'two', 'three' %}{% endcapture %}
                    {% if thecycle == 'one' %}
                        <div class="row-fluid equalHero equalHeights">
                    {% endif %}
                            <div class="span4 sparkNowTile">
                                <div class="sparkNowTileTop">
                                    {% for tag in post.tag_list limit:1 %}
                                        <a href="/posts/{{post.slug}}" class="sparkNowTileTag">{{tag}}</a>
                                    {% endfor %}
                                    <a href="/posts/{{post.slug}}" class="sparkNowTileImg">
                                        <img src="{{post.image_path}}" class="aligncenter" alt="" />
                                    </a>
                                </div>
                                <div class="sparkNowTileTitle"><a href="/posts/{{post.slug}}"><h3>{{ post.title }}</h3></a></div>
                            </div>
                    {% if thecycle == 'three' or forloop.last %}
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>
        {% endif %}
        <!--close entry-related-->
    </div>
    <!--close .container id="main-content" --> 
</div>
<script>
    $(document).ready(function() {
        function renderPageData(){
            var pathArray = window.location.pathname.split( '/' );
            var slug = pathArray[pathArray.length-1];
            var blog_detail = getPostDetailsBySlug(slug);
            // checkErrorPage(blog_detail);
           
            var publish_date = new Date(blog_detail.publish_date);
            console.log(blog_detail.publish_date);
            
            var month_names_short = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec']
            blog_detail.publish_date_month = month_names_short[publish_date.getMonth()]
            blog_detail.publish_date_day = publish_date.getDate()

            renderPostDetailTemplate('#blog_detail_template', '#blog_detail_container',blog_detail);
            renderPostListTemplate('#blog_list_template', '#blog_list_container',getPostList());
            // $('#loading').hide();
            // $('#page_content').fadeIn('fast');
            
            //change img url
            $('.blog_detail_description img').attr('src',function(i,e){
                return e.replace("/system","http://cdn.mallmaverick.com/system");
            });
        }
        
        loadMallData(renderPageData);
    });
    
    function renderPostDetailTemplate(blog_detail_template, blog_block, post){
    
        var item_list = [];
        var blog_template_html = $(blog_detail_template).html();
        Mustache.parse(blog_template_html);   // optional, speeds up future uses
    
       
        var blog_rendered = Mustache.render(blog_template_html,post);
        item_list.push(blog_rendered);
        $(blog_block).html(item_list.join(''));
    }
    
    function renderPostListTemplate(blog_template, blog_block, post){
        var item_list = [];
        var item_rendered = [];
        var blog_template_html = $(blog_template).html();
        Mustache.parse(blog_template_html);   // optional, speeds up future uses
    
        $.each( post , function( key, val ) {
            item_list.push(val);
        });
        // $.each( item_list , function(key,val){
        //     if(val.tag.length != 0){
        //         val.tag_first = val.tag[0];
        //     }
        //     if(val.impression_count < 20){
        //         val.impression_tile_class = "sparkNowTileReadCount1";
        //     }else if (val.impression_count < 50){
        //         val.impression_tile_class = "sparkNowTileReadCount2";
        //     }else if (val.impression_count < 100){
        //         val.impression_tile_class = "sparkNowTileReadCount3";
        //     }else{
        //         val.impression_tile_class = "sparkNowTileReadCount4";
        //     }
        //     console.log(val);
        // });
        item_list.sort(function(a, b){
            if(a.publish_date > b.publish_date) return -1;
            if(a.publish_date < b.publish_date) return 1;
            return 0;
        });
        // $.each( item_list , function( key, val ) {
        //     var blog_rendered = Mustache.render(blog_template_html,val);
        //     item_rendered.push(blog_rendered);
        // });
        // Mustache.render(blog_template_html,val);
        console.log(item_list);
        // $(blog_block).html(item_rendered.join(''));


        var blog_rendered = Mustache.render(blog_template_html,post);
        item_list.push(blog_rendered);
        $(blog_block).html(item_list.join(''));
    }
</script>    